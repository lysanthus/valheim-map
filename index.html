<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Valheim World Map</title>

  <!-- World Seed: 8yz7mzFzt7 -->
  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

  <!-- Leaflet.draw plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css">

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .suggest-panel {
      position: absolute;
      top: 70px;
      left: 10px;
      width: 260px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 10px;
      font-family: sans-serif;
      font-size: 12px;
      border-radius: 4px;
      z-index: 1000;
    }
    
    .suggest-panel label {
      display: block;
      margin-top: 4px;
      margin-bottom: 2px;
    }
    
    .suggest-panel input,
    .suggest-panel select,
    .suggest-panel textarea {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 4px;
      font-size: 12px;
    }
    
    .suggest-panel textarea {
      resize: vertical;
    }
    
    .suggest-panel-buttons {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 4px;
    }
    
    .suggest-panel button {
      flex: 1;
      padding: 3px 4px;
      font-size: 11px;
      cursor: pointer;
    }
    
    .hidden {
      display: none;
    }
    
    .suggest-active {
      outline: 2px solid #ffd700;
    }

    .coords-panel {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 6px 10px;
      font-family: monospace;
      font-size: 13px;
      border-radius: 4px;
      z-index: 1000;
    }

    .legend {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 8px 10px;
      font-family: sans-serif;
      font-size: 13px;
      border-radius: 4px;
      z-index: 1000;
    }
    
    .legend-dot {
      display: inline-block;
      width: 14px;     /* matches radius ~7-ish visually */
      height: 14px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
      border: 2px solid;
    }

    .legend div {
      margin-bottom: 4px;
    }

    /* Always-visible labels for certain points */
    .map-label {
      font-family: sans-serif;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      text-shadow: 0 0 3px #000, 0 0 6px #000;
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0 2px;
    }

    /* Remove pointer triangle on permanent tooltips */
    .leaflet-tooltip.map-label:before,
    .leaflet-tooltip.map-label:after {
      display: none;
    }

    /* Road labels (if you decide to use them later) */
    .road-label {
      font-family: sans-serif;
      font-size: 13px;
      font-weight: 700;
      color: #ffffff;
      text-shadow: 0 0 4px #000, 0 0 6px #000;
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0 2px;
    }

    /* Panel showing last exported GeoJSON */
    .export-panel {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 320px;
      max-height: 200px;
      background: rgba(255,255,255,0.95);
      border-radius: 4px;
      padding: 6px 8px;
      font-family: monospace;
      font-size: 11px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .export-panel label {
      font-family: sans-serif;
      font-size: 11px;
      font-weight: 600;
    }

    .export-panel textarea {
      flex: 1;
      resize: none;
      width: 100%;
      box-sizing: border-box;
    }
    
    .leaflet-tooltip.map-label {
      opacity: 0;
      transition: opacity 0.15s ease-in-out;
    }
    
    .leaflet-tooltip.map-label.leaflet-tooltip-visible {
      opacity: 1;
    }
    
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="coords" class="coords-panel">Click the map to get pixel coordinates…</div>
  <div class="legend">
    <strong>Legend</strong>
    <div>
      <span class="legend-dot" style="background:#00cc00; border-color:#006600;"></span>
      Base
    </div>
    <div>
      <span class="legend-dot" style="background:#800080; border-color:#400040;"></span>
      Portal
    </div>
    <div>
      <span class="legend-dot" style="background:#ffa500; border-color:#cc8400;"></span>
      Outpost
    </div>
    <div>
      <span class="legend-dot" style="background:#0000ff; border-color:#000080;"></span>
      Default POI
    </div>
    <div style="margin-top:4px;">
      <span style="font-size: 16px;">—</span>
      Road
    </div>
  </div>

  <div class="export-panel">
    <label for="exportText">Last drawn road (GeoJSON Feature)</label>
    <textarea id="exportText" rows="6" spellcheck="false"
      placeholder="Use the polyline tool in the toolbar to draw a road.&#10;The resulting GeoJSON snippet will appear here."></textarea>
  </div>
  
  <button id="suggestPoiBtn"
        style="position:absolute; top:160px; right:25px; z-index:1000;">
    + Suggest POI
  </button>
    
    <div id="suggestPanel" class="suggest-panel hidden">
      <div><strong>Suggest a POI</strong></div>
      <div style="margin-bottom:4px; font-size:11px;">
        Fill in details, then click on the map to place it.
      </div>
    
      <label for="poiName">Name</label>
      <input id="poiName" type="text" placeholder="e.g. Swamp Outpost">
    
      <label for="poiKind">Type</label>
      <select id="poiKind">
        <option value="base">Base</option>
        <option value="outpost">Outpost</option>
        <option value="portal">Portal</option>
        <option value="poi">Generic POI</option>
      </select>
    
      <label for="poiNotes">Notes</label>
      <textarea id="poiNotes" rows="3" placeholder="e.g. small shack, portal to iron farm"></textarea>
    
      <label for="poiJson">JSON snippet (send to Adam)</label>
      <textarea id="poiJson" rows="5" readonly
                placeholder="After you click the map, the JSON will appear here."></textarea>
    
      <div class="suggest-panel-buttons">
        <button type="button" id="clearPoiBtn">Clear</button>
        <button type="button" id="closePoiBtn">Close</button>
      </div>
    </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>

  <script>
    // Image size in pixels
    const IMG_WIDTH = 4096;
    const IMG_HEIGHT = 4096;

    // Create a Leaflet map using a simple CRS (no real-world projection)
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2
    });
    
    // Define the map bounds in "pixel coordinates": [y, x]
    const bounds = [[0, 0], [IMG_HEIGHT, IMG_WIDTH]];

    // Add the image overlay
    L.imageOverlay('map.png', bounds).addTo(map);

    // Center and zoom (you already picked a zoom level you like)
    map.setView([IMG_HEIGHT / 2, IMG_WIDTH / 2], 1); // adjust zoom as desired
    
    // --- MiniMap setup ---

    // Use a separate imageOverlay layer for the minimap
    const miniLayer = L.imageOverlay('map.png', bounds);
    
    const fixedMiniZoom = -5;  // whatever zoom you liked best
    
    const miniMap = new L.Control.MiniMap(miniLayer, {
      position: 'topleft',
      width: 150,
      height: 150,
    
      // Fixed zoom level for the minimap
      zoomLevelFixed: fixedMiniZoom,
    
      // Make the minimap use the same CRS and lock zoom,
      // and also prevent the minimap itself from being dragged/zoomed.
      mapOptions: {
        crs: L.CRS.Simple,
        minZoom: fixedMiniZoom,
        maxZoom: fixedMiniZoom,
        zoomControl: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        touchZoom: false,
        boxZoom: false,
        keyboard: false,
        dragging: false   // <-- key: minimap image no longer drags
      },
    
      // NOTE: no centerFixed here; we want the minimap to follow the main map
    
      aimingRectOptions: { weight: 1 },
      shadowRectOptions: { weight: 0, opacity: 0 },
      toggleDisplay: true
    });
    
    miniMap.addTo(map);

    // --- Suggest POI UI wiring ---

    const suggestBtn   = document.getElementById('suggestPoiBtn');
    const suggestPanel = document.getElementById('suggestPanel');
    const poiNameInput = document.getElementById('poiName');
    const poiKindInput = document.getElementById('poiKind');
    const poiNotesInput = document.getElementById('poiNotes');
    const poiJsonOutput = document.getElementById('poiJson');
    const clearPoiBtn  = document.getElementById('clearPoiBtn');
    const closePoiBtn  = document.getElementById('closePoiBtn');
    
    let suggestMode = false;
    
    function setSuggestMode(on) {
      suggestMode = on;
      if (on) {
        suggestPanel.classList.remove('hidden');
        suggestBtn.classList.add('suggest-active');
      } else {
        suggestPanel.classList.add('hidden');
        suggestBtn.classList.remove('suggest-active');
      }
    }
    
    // Toggle button
    suggestBtn.addEventListener('click', () => {
      setSuggestMode(!suggestMode);
    });
    
    // Clear fields
    clearPoiBtn.addEventListener('click', () => {
      poiNameInput.value = '';
      poiNotesInput.value = '';
      poiJsonOutput.value = '';
    });
    
    // Close panel and exit suggest mode
    closePoiBtn.addEventListener('click', () => {
      setSuggestMode(false);
    });



    // -------------------------
    //  Feature styling
    // -------------------------

    function pointToLayer(feature, latlng) {
      const kind = feature.properties && feature.properties.kind;
      let radius = 6;
      let color = '#000';
      let fillColor = '#fff';
      let options;
    
      if (kind === 'base') {
        radius = 12;
        fillColor = '#00cc00';    // bright green
        color = '#006600';        // darker green outline
        options = {
          radius,
          weight: 2,
          color,
          fillColor,
          fillOpacity: 1
        };
    
      } else if (kind === 'portal') {
        radius = 8;
        fillColor = '#800080';    // purple
        color = '#400040';
        options = {
          radius,
          weight: 2,
          color,
          fillColor,
          fillOpacity: 1
        };
    
      } else if (kind === 'outpost') {
        // New type: smaller, orange-ish
        radius = 9;
        fillColor = '#ffa500';    // orange
        color = '#cc8400';        // darker orange outline
        options = {
          radius,
          weight: 2,
          color,
          fillColor,
          fillOpacity: 1
        };
    
      } else if (kind === 'hidden') {
        // Invisible marker, used only as an anchor for labels
        options = {
          radius: 0,
          stroke: false,
          fill: false,
          opacity: 0,
          fillOpacity: 0,
          interactive: false
        };
    
      } else {
        // Default point
        fillColor = '#0000ff';
        color = '#000080';
        options = {
          radius,
          weight: 2,
          color,
          fillColor,
          fillOpacity: 1
        };
      }
    
      return L.circleMarker(latlng, options);
    }

    function style(feature) {
      const kind = feature.properties && feature.properties.kind;
      if (kind === 'road') {
        return {
          weight: 5
        };
      }
      return {};
    }

    function onEachFeature(feature, layer) {
      const props = feature.properties || {};
    
      // 1) Hidden label-only points: always visible label, no popup
      if (props.kind === 'hidden' && props.name) {
        layer.bindTooltip(props.name, {
          permanent: true,
          direction: 'right',
          offset: [8, 0],
          className: 'map-label'
        }).openTooltip();
    
        // No popup for hidden points; bail out early
        return;
      }
    
      // 2) Everything else with a name: hover label
      if (props.name) {
        layer.bindTooltip(props.name, {
          permanent: false,      // show on hover
          direction: 'top',
          offset: [0, -8],
          className: 'map-label'
        });
      }
    
      // 3) Rich popup on click (name + notes)
      if (props.name || props.notes) {
        let popup = "";
    
        if (props.name) {
          popup += `<strong>${props.name}</strong>`;
        }
        if (props.notes) {
          if (popup) popup += "<br>";
          popup += props.notes;
        }
    
        if (popup) {
          layer.bindPopup(popup);
        }
      }
    }

    // -------------------------
    //  Load existing features
    // -------------------------
    fetch('features.json')
      .then(response => response.json())
      .then(data => {
        L.geoJSON(data, {
          pointToLayer: pointToLayer,
          style: style,
          onEachFeature: onEachFeature
        }).addTo(map);
      })
      .catch(err => {
        console.error('Error loading features.json:', err);
      });

    // -------------------------
    //  Click to get pixel coordinates
    // -------------------------
    const coordsDiv = document.getElementById('coords');

    map.on('click', function(e) {
      const x = Math.round(e.latlng.lng);
      const y = Math.round(e.latlng.lat);
    
      coordsDiv.textContent = `x: ${x}, y: ${y}`;
    
      // If we're in Suggest POI mode, build a snippet for the player
      if (suggestMode) {
        const name = poiNameInput.value.trim() || "New POI";
        const kind = (poiKindInput.value || "poi").trim();
        const notes = poiNotesInput.value.trim();
    
        const feature = {
          type: "Feature",
          properties: {
            name: name,
            kind: kind,
            notes: notes
          },
          geometry: {
            type: "Point",
            coordinates: [x, y]
          }
        };
    
        const jsonText = JSON.stringify(feature, null, 2);
        poiJsonOutput.value = jsonText;
    
        console.log('Suggested POI Feature:', jsonText);
    
        // Optional: small alert to confirm
        // alert("POI JSON generated below. Copy it and send it to the GM!");
    
        return; // don't also generate the default snippet
      }
    
      // Normal behavior when NOT in suggest mode:
      const snippet = {
        type: "Feature",
        properties: {
          name: "New Place",
          kind: "base",
          notes: ""
        },
        geometry: {
          type: "Point",
          coordinates: [x, y]
        }
      };
      console.log('GeoJSON Point snippet:', JSON.stringify(snippet, null, 2));
    });

    // -------------------------
    //  Leaflet.draw setup
    // -------------------------
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: {
        polygon: false,
        rectangle: false,
        circle: false,
        circlemarker: false,
        marker: false,
        polyline: {
          shapeOptions: {
            weight: 3
          }
        }
      },
      edit: {
        featureGroup: drawnItems,
        edit: false,
        remove: false
      }
    });

    map.addControl(drawControl);

    const exportText = document.getElementById('exportText');

    // When a new shape is created with Leaflet.draw
    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);

      // Convert to GeoJSON
      const gj = layer.toGeoJSON();

      // gj.geometry.coordinates are [lng, lat] pairs in our CRS,
      // which map directly to [x, y] pixels. We'll round them.
      const coords = gj.geometry.coordinates.map(function (c) {
        return [Math.round(c[0]), Math.round(c[1])];
      });

      // Create a ready-to-paste Feature for features.json
      const feature = {
        type: "Feature",
        properties: {
          name: "New Road",
          kind: "road",
          notes: ""
        },
        geometry: {
          type: "LineString",
          coordinates: coords
        }
      };

      const snippet = JSON.stringify(feature, null, 2);

      console.log('New road Feature:', snippet);
      if (exportText) {
        exportText.value = snippet;
      }

      alert("Road drawn! A GeoJSON Feature for it is now in the bottom-right panel and in the browser console.\n\nCopy it into features.json under \"features\".");
    });
  </script>
</body>
</html>